const NOTION_KEY = "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";
const DB_ID = "2f633fbfb00e8178bf12d3a1da03aff2";

const updates: Record<string, string> = {
  "Сергей Гипш": `Привет, Сергей. Меня зовут Паша Папин.\n\nЗнаю историю перехода из Knight Frank Russia в NF Group Middle East — 28+ лет опыта на рынке это серьёзная экспертиза. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nИнтересно услышать твоё мнение, как такой инструмент может быть вам полезен. У тебя будет 15 минут на звонок на этой неделе?`,

  "Искандер Халилов": `Привет, Искандер. Меня зовут Паша Папин.\n\nRustar работает с 2003 года и 3000+ объектов продано — один из пионеров рынка Дубая. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nПри таком объёме visibility по сделкам — критично. Интересно услышать твоё мнение. У тебя будет 15 минут на звонок на этой неделе?`,

  "Дмитрий Зыков": `Привет, Дмитрий. Меня зовут Паша Папин.\n\nDDA Real Estate работает с 2007 года на международном уровне — серьёзный опыт. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nИнтересно услышать твоё мнение, как такой инструмент может быть вам полезен. У тебя будет 15 минут на звонок на этой неделе?`,

  "Александр Григорьев": `Привет, Александр. Меня зовут Паша Папин.\n\nЗацепила философия Fame Estate — индивидуальный подход, офисы в Дубае и Бангкоке. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nИнтересно услышать твоё мнение, как такой инструмент может быть полезен. У тебя будет 15 минут на звонок на этой неделе?`,

  "Виктор Слепец": `Привет, Виктор. Меня зовут Паша Папин.\n\nDDA Real Estate работает с 2007 года — международное агентство с серьёзным опытом. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nИнтересно услышать твоё мнение, как такой инструмент может быть вам полезен. У тебя будет 15 минут на звонок на этой неделе?`,

  "Анастасия Яковлева": `Привет, Анастасия. Меня зовут Паша Папин.\n\nDDA Real Estate работает с 2007 года на международном уровне. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nИнтересно услышать твоё мнение, как такой инструмент может быть полезен. У тебя будет 15 минут на звонок на этой неделе?`,

  "Дарья Блаженнова": `Привет, Дарья. Меня зовут Паша Папин.\n\nFame Estate за 4 года выросла до офисов в Дубае и Бангкоке — серьёзный результат. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nИнтересно услышать твоё мнение, как такой инструмент может быть полезен. У тебя будет 15 минут на звонок на этой неделе?`,

  "AKORD (Основатель)": `Привет. Меня зовут Паша Папин.\n\nAKORD Real Estate — 8 лет на рынке элитной недвижимости Дубая, это серьёзный опыт. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nИнтересно услышать ваше мнение, как такой инструмент может быть полезен. У вас будет 15 минут на звонок на этой неделе?`,

  "AEMETRIA (Основатель)": `Привет. Меня зовут Паша Папин.\n\nВидел, что AEMETRIA работает из Dubai Media City — серьёзная локация. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nИнтересно услышать ваше мнение, как такой инструмент может быть полезен. У вас будет 15 минут на звонок на этой неделе?`,

  "THEBROKS (Основатель)": `Привет. Меня зовут Паша Папин.\n\nTHEBROKS — инвестиции в недвижимость ОАЭ, интересная ниша. Решил написать.\n\nМы делаем elio, сервис для real estate агентств в Дубае, который даёт visibility по WhatsApp-сделкам, помогает держать качество и SLA работы sales и подсказывает, где внимание нужно прямо сейчас, чтобы не терять сделки.\n\nИнтересно услышать ваше мнение, как такой инструмент может быть полезен. У вас будет 15 минут на звонок на этой неделе?`,
};

async function getAllPages(): Promise<any[]> {
  let pages: any[] = [];
  let cursor: string | undefined;
  do {
    const body: any = { page_size: 100 };
    if (cursor) body.start_cursor = cursor;
    const r = await fetch(`https://api.notion.com/v1/databases/${DB_ID}/query`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${NOTION_KEY}`, "Notion-Version": "2022-06-28", "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    const data: any = await r.json();
    pages = pages.concat(data.results || []);
    cursor = data.has_more ? data.next_cursor : undefined;
  } while (cursor);
  return pages;
}

async function main() {
  const pages = await getAllPages();

  const noMsg = pages.filter(p => {
    const msg = p.properties?.["Message"]?.rich_text?.[0]?.plain_text || "";
    return msg.length === 0;
  });

  console.log(`${noMsg.length} contacts without messages\n`);

  for (const p of noMsg) {
    const name = p.properties?.["Name"]?.title?.[0]?.plain_text || "?";
    const msg = updates[name];
    if (!msg) {
      console.log(`✗ ${name} — no message prepared`);
      continue;
    }
    const r = await fetch(`https://api.notion.com/v1/pages/${p.id}`, {
      method: "PATCH",
      headers: { "Authorization": `Bearer ${NOTION_KEY}`, "Notion-Version": "2022-06-28", "Content-Type": "application/json" },
      body: JSON.stringify({ properties: { "Message": { rich_text: [{ text: { content: msg.slice(0, 2000) } }] } } }),
    });
    console.log(r.ok ? `✓ ${name}` : `✗ ${name} — error ${r.status}`);
  }
}
main();
